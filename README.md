# good-food

![good_food workflow](https://github.com/healthy-food-and-dietary-products/backend/actions/workflows/good_food_workflow.yaml/badge.svg)

## Локальный запуск приложения в контейнерах

### Клонирование репозитория, создание контейнеров и первоначальная настройка

_Важно: при работе в Linux или через терминал WSL2 все команды docker и docker compose нужно выполнять от имени суперпользователя — начинайте их с sudo._

Склонировать репозиторий на свой компьютер и перейти в него:
```
git clone git@github.com:healthy-food-and-dietary-products/backend.git
cd backend
```

Создать в папках infra и backend/good_food файл .env с переменными окружения, необходимыми 
для работы приложения.

Пример содержимого файла:
```
SECRET_KEY=key
DB_ENGINE=django.db.backends.postgresql
DB_NAME=postgres
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
DB_HOST=db
DB_PORT=5432
EMAIL_HOST_USER=<ваш емейл>
EMAIL_HOST_PASSWORD=<ваш пароль>
MODE=prod
DOCKER=yes
ALLOWED_HOSTS=localhost web
CSRF_TRUSTED_ORIGINS=http://localhost/*
```

Перейти в папку /infra/ и запустить сборку контейнеров с помощью 
docker compose: 
```
cd infra
docker compose up -d
```
После этого будут созданы и запущены в фоновом режиме контейнеры 
(db, web, frontend и nginx).

Внутри контейнера web выполнить миграции и создать админа-суперпользователя для входа 
в Админку:
```
docker-compose exec web python manage.py migrate
docker-compose exec web python manage.py createsuperuser
```
После этого Админка должна быть доступна по адресу: http://localhost/admin/
API Root будет доступен по адресу: http://localhost/api/

### Остановка контейнеров

Для остановки работы приложения можно набрать в терминале команду Ctrl+C 
либо открыть второй терминал и воспользоваться командой
```
docker compose stop 
```
Снова запустить контейнеры без их пересборки можно командой
```
docker compose start 
```

### Динамическая документация api 

- Swagger - http://localhost/api/swagger/
- Redoc - http://localhost/api/redoc/

## Пользователи

### Создание пользователей

Создание пользователя доступно по эндоинту /api/users/
Для создания пользователя необходимо post-запросом отправить следующие обязательные поля:
- email
- username
- password

Помимо этих полей обязательным при регистации пользователя является поле "Город",
в котором в настоящий момент автоматически указывается "Москва". 

### Аутентификация пользователей

Аутентификация пользователя доступна по эндпойнту /api/token/login/
Для аутентификации необходимо post-запросом отправить следующие обязательные поля:
- email
- password

Чтобы авторизоваться по полученному токену, нужно передать в заголовок
Authorization значение "Token <токен>", например, Token 45645hylijglu54545

### Личный кабинет пользователя

Личный кабинет аутентифицированного пользователя доступен по эндпойнту /api/users/me/ 
Там можно посмотреть информацию о себе (GET-запрос), отредактировать её
(PUT- и PATCH-запросы), в том числе путем добавления новых адресов для доставки,
а также удалить пользователя (DELETE-запрос).

## Продукты

### Эндпойнты апи для продуктов и связанных с ними сущностей

Эндпойнт для продуктов находится на /api/products/

С ним связаны эндпойнты:
- категорий /api/categories/
- подкатегорий /api/subcategories/
- компонентов /api/components
- тегов /api/tags/
- производителей /api/producers/
- промоакций /api/promotions/
- избранных продуктов /api/favorite-products/

### Просмотр информации о продуктах, их категориях, подкатегориях, тегах, компонентах, производителях и промоакциях

Просмотр информации о продуктах, а также их категориях, подкатегориях, тегах,
компонентах, производителях и промоакциях доступен как авторизованным, так и
неавторизованным пользователям. Для этого нужно отправить POST-запрос на нужный эндпойнт.

Эндпойнт избранных продуктов (/api/favorite-products/) доступен только админам.
Добавлять и удалять продукты из Избранного могут авторизованные пользователи,
об этом написано в одном из следующих разделов.

### Создание новых продуктов, категорий, подкатегорий, тегов, компонентов, производителей и промоакций

Создание доступно только админам с помощью POST-запросов на нужные эндпойнты.

Перед созданием нового продукта нужно решить, к каким категории, подкатегории, тегам, производителям
он будет принадлежать, а также какие компоненты будут в него входить.

_Категория_

Для создания новой категории нужно передать на эндпойнт /api/categories/ поля category_name
и slug. Если не передать в запросе значение для поля slug, то оно будет автоматически 
сгенерировано из значения в поле category_name.

Пример POST запроса:
```
{
  "category_name": "фрукты",
  "slug": "fruit"
}
```

Пример ответа:
```
{
  "id": 11,
  "category_name": "фрукты",
  "slug": "fruit"
}
```

_Подкатегория_

Для создания новой подкатегории нужно передать на эндпойнт /api/subcategories/ поля
parent_category (указать id категории, к которой принадлежит создаваемая подкатегория),
name и slug.
Если не передать в запросе значение для поля slug, то оно будет автоматически 
сгенерировано из значения в поле name.

Пример POST запроса:
```
{
  "parent_category": 2,
  "name": "соль",
  "slug": "salt"
}
```

Пример ответа:
```
{
  "id": 9,
  "parent_category": 2,
  "name": "соль",
  "slug": "salt"
}
```

_Тег_

Для создания нового тега нужно передать на эндпойнт /api/tags/ поля name и slug.
Если не передать в запросе значение для поля slug, то оно будет автоматически 
сгенерировано из значения в поле name.

Пример POST запроса:
```
{
  "name": "завтрак",
  "slug": "breakfast"
}
```

Пример ответа:
```
{
  "id": 6,
  "name": "завтрак",
  "slug": "breakfast"
}
```

_Компонент_

Для создания нового компонента нужно передать на эндпойнт /api/components/ поля name и slug.
Если не передать в запросе значение для поля slug, то оно будет автоматически 
сгенерировано из значения в поле name.

Пример POST запроса:
```
{
  "name": "имбирь",
  "slug": "ginger"
}
```

Пример ответа:
```
{
  "id": 22,
  "name": "имбирь",
  "slug": "ginger"
}
```

_Производитель_

Для создания нового производителя нужно передать на эндпойнт /api/producers/ поля
name, slug, producer_type (выбор между "company" и "entrepreneur"), description
(необязательное поле) и address.
Если не передать в запросе значение для поля slug, то оно будет автоматически 
сгенерировано из значения в поле name.

Пример POST запроса:
```
{
  "name": "Самый лучший производитель",
  "slug": "best-producer",
  "producer_type": "company",
  "description": "Best producer ever!",
  "address": "Москва, Земляной вал, д.5"
}
```

Пример ответа:
```
{
  "id": 5,
  "name": "Самый лучший производитель",
  "slug": "best-producer",
  "producer_type": "company",
  "description": "Best producer ever!",
  "address": "Москва, Земляной вал, д.5"
}
```

_Промоакция_

Для создания новой промоакции нужно передать на эндпойнт /api/promotions/ поля
promotion_type (выбор между simple, birthday, loyalty_card, expired_soon, present,
two_for_one, multiple_items), name, slug, discount (от 0 до 100 включительно),
conditions (необязательное поле), is_active (по умолчанию true), is_constant (по 
умолчанию false), start_time (необязательное поле, вставить дату и время) и
end_time (необязательное поле, вставить дату и время).
Если не передать в запросе значение для поля slug, то оно будет автоматически 
сгенерировано из значения в поле name.

Пример POST запроса:
```
{
  "promotion_type": "expired_soon",
  "name": "Скидка 30% на товары с истекающим сроком годности",
  "discount": 30,
  "conditions": "Срок годности заканчивается завтра",
  "is_active": true,
  "is_constant": false,
  "start_time": "2023-11-13T07:06:20.011Z"
}
```

Пример ответа:
```
{
  "id": 3,
  "promotion_type": "expired_soon",
  "name": "Скидка 30% на товары с истекающим сроком годности",
  "discount": 30,
  "conditions": "Срок годности заканчивается завтра",
  "is_active": true,
  "is_constant": false,
  "start_time": "2023-11-13T10:06:20.011000+03:00",
  "end_time": null
}
```

_Продукт_

Для создания нового продукта нужно передать на эндпойнт /api/products/ поля:
- name, 
- description (необязательное поле), 
- subcategory (id подкатегории, из нее в процессе создания продукта будет получена категория - parent category для данной подкатегории),
- tags (необязательное поле, в которое передаются в виде списка id тегов),
- discontinued (по умолчанию false, данное поле показывает, снят ли товар нами с продажи),
- producer (указать id производителя продукта),
- measure_unit (выбор между grams, milliliters и items, по умолчанию items),
- amount (положительное число, показывающее количество граммов/миллилитров или штук в единице данного продукта, по умолчанию равно 1),
- price (неотрицательное число),
- components (список id компонентов, из которых состоит данный продукт),
- kcal (количество ккал в 100 г. продукта, неотрицательное число),
- proteins (количество белков в 100 г. продукта, неотрицательное число),
- fats (количество жиров в 100 г. продукта, неотрицательное число),
- carbohydrates (количество углеводов в 100 г. продукта, неотрицательное число)

Фото продукта следует загружать через Админку, чтобы оно попало в нужную папку.

Пример POST запроса:
```
{
  "name": "Cоль гималайская",
  "description": "Соль и специи",
  "subcategory": 9,
  "tags": [
    6
  ],
  "discontinued": false,
  "producer": 5,
  "measure_unit": "grams",
  "amount": 1000,
  "price": 100,
  "components": [
    9, 22
  ],
  "kcal": 0,
  "proteins": 0,
  "fats": 0,
  "carbohydrates": 0
}
```

Пример ответа:
```
{
  "id": 4,
  "name": "Cоль гималайская",
  "description": "Соль и специи",
  "creation_time": "2023-11-13T10:16:36.059375+03:00",
  "category": 2,
  "subcategory": 9,
  "tags": [
    6
  ],
  "discontinued": false,
  "producer": 5,
  "measure_unit": "grams",
  "amount": 1000,
  "price": 100,
  "final_price": 100,
  "photo": null,
  "components": [
    9,
    22
  ],
  "kcal": 0,
  "proteins": 0,
  "fats": 0,
  "carbohydrates": 0
}
```

## Корзина покупок

### Создание корзины покупок

Создание корзины покупок доступно по эндпойнту /api/users/{user_id}/shopping_cart/
Оно доступно только авторизованному пользователю.
Для создания корзины необходимо отправить на указанный эндпойнт POST-запрос с полем products(id, quantity)

Пример POST запроса на создание корзины:
```
{
  "products": [
    {"id": "1", "quantity": "9"}, 
    {"id": "3", "quantity": "10"}
  ]
}
```

### Изменение корзины покупок

Изменение корзины покупок доступно по эндойнту /api/users/{user_id}/shopping_cart/{shopping_cart_id}/
Оно доступно только авторизованному пользователю.
Для изменения корзины на указанный эндпойнт необходимо передать PATCH-запросом id корзины (в URL)
и обязательные поля: products(id, quantity).

Пример PATCH запроса на изменение корзины:
```
{
  "products": [
    {"id": "1", "quantity": "9"}, 
    {"id": "3", "quantity": "1"}
  ]
}
```

### Удаление корзины покупок

Удаление корзины покупок доступно по эндпойнту /api/users/{user_id}/shopping_cart/{shopping_cart_id}/
Оно доступно только авторизованному пользователю в отношении собственной корзины.
Для удаления корзины покупок необходимо передать в URL id корзины во время DELETE-запроса
на указанный эндпойнт.
